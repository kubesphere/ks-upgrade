package download

import (
	"encoding/base64"
	"testing"

	"github.com/stretchr/testify/assert"
)

func TestHttpDownloaderGet(t *testing.T) {
	uri := "https://test:test@charts.kubesphere.io/test/ks-core-0.6.12.tgz"
	d, err := NewHttpDownloader(&HttpDownloaderOptions{
		Timeout: 5,
	})
	assert.Equal(t, err, nil)
	_, err = d.Get(uri)
	assert.Equal(t, err, nil)
	_, err = d.Get(uri)
	assert.Equal(t, err, nil)
}

func TestLoadCaBundle(t *testing.T) {
	caBundleCrt := `-----BEGIN CERTIFICATE-----
MIIDWzCCAkOgAwIBAgIUe9v6qyOVZ31sH/WGSNCrPVSWYXMwDQYJKoZIhvcNAQEL
BQAwPDELMAkGA1UEBhMCQ04xCzAJBgNVBAgMAkhCMQswCQYDVQQKDAJRQzETMBEG
A1UEAwwKa3MtY29uc29sZTAgFw0yNDAzMzExNTA4MTlaGA8yMDUxMDgxNzE1MDgx
OVowPDELMAkGA1UEBhMCQ04xCzAJBgNVBAgMAkhCMQswCQYDVQQKDAJRQzETMBEG
A1UEAwwKa3MtY29uc29sZTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEB
ANjfyIc0ZQM1O04TSUxV7h6GzasGtakO8AOTiEbED3pHJQWxqGJIRsaN0mLsPtMs
tZ1DrupO4dFLF++IOjP7bRgEEw4jiMjEQH8dt6b6jI/ovMHpIw68cdFmFWZrVAXP
3x5ykh8UtVk328AekXgA3vwLx+nCWiW2nbmRj9HCiLJzRx5qSRBu2lnA66njbWZq
FKLg3MoZnbmFZJlbChimSwMhENtZEIKLbe3lvXnrGjB8z8NVZdfluloxlnZ3Kg39
rjc/SGAOWEiN9MBTq3QGwGL7e1VotYDuirqOk1ROOGPH5e44Yc6D4rw+5ckIDgq6
0VZQYLmJOngU106nQZA/K/MCAwEAAaNTMFEwHQYDVR0OBBYEFOn2yI7gDEv5D0zs
BjwILZokcT9RMB8GA1UdIwQYMBaAFOn2yI7gDEv5D0zsBjwILZokcT9RMA8GA1Ud
EwEB/wQFMAMBAf8wDQYJKoZIhvcNAQELBQADggEBAJeDw5QE//3pu7tXwzPxUgpj
O62j+SJZKPPfhqCFvxT8ZfciOb2X9JVEiRlOcdH6l6q8AuCzRhNVgZ6zLUGmCgyu
utMEx1cOxMS0AIrm4K18Y61SbQ/wmEIlwH+lECYdN+Ht0hgNOf2sAOLJBFovj4pd
4tNTQvXtxsqiA67WITDouDhEB1OXM9JLlojRy6vKRXUD3DXQ2BL+srji+7/nui6W
Fk7JDfUlKwz7C9yqnh8T1a2BdV/HLhl6yD/jfkTRH8edDYc5kIGgA/1vTuhqV086
Fx4zz8Ijm0kvmu/bOS5uHbFoOulnRecEjYOlvSW/PjhwMajuIlgInGSKhDx1lp8=
-----END CERTIFICATE-----`
	caBundle := base64.StdEncoding.EncodeToString([]byte(caBundleCrt))
	t.Log(caBundle)

	caBundleCrt = `-----BEGIN CERTIFICATE-----
MIIDWzCCAkOgAwIBAgIUe9v6qyOVZ31sH/WGSNCrPVSWYXMwDQYJKoZIhvcNAQEL
BQAwPDELMAkGA1UEBhMCQ04xCzAJBgNVBAgMAkhCMQswCQYDVQQKDAJRQzETMBEG
A1UEAwwKa3MtY29uc29sZTAgFw0yNDAzMzExNTA4MTlaGA8yMDUxMDgxNzE1MDgx
OVowPDELMAkGA1UEBhMCQ04xCzAJBgNVBAgMAkhCMQswCQYDVQQKDAJRQzETMBEG
A1UEAwwKa3MtY29uc29sZTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEB
ANjfyIc0ZQM1O04TSUxV7h6GzasGtakO8AOTiEbED3pHJQWxqGJIRsaN0mLsPtMs
tZ1DrupO4dFLF++IOjP7bRgEEw4jiMjEQH8dt6b6jI/ovMHpIw68cdFmFWZrVAXP
3x5ykh8UtVk328AekXgA3vwLx+nCWiW2nbmRj9HCiLJzRx5qSRBu2lnA66njbWZq
FKLg3MoZnbmFZJlbChimSwMhENtZEIKLbe3lvXnrGjB8z8NVZdfluloxlnZ3Kg39
rjc/SGAOWEiN9MBTq3QGwGL7e1VotYDuirqOk1ROOGPH5e44Yc6D4rw+5ckIDgq6
0VZQYLmJOngU106nQZA/K/MCAwEAAaNTMFEwHQYDVR0OBBYEFOn2yI7gDEv5D0zs
BjwILZokcT9RMB8GA1UdIwQYMBaAFOn2yI7gDEv5D0zsBjwILZokcT9RMA8GA1Ud
EwEB/wQFMAMBAf8wDQYJKoZIhvcNAQELBQADggEBAJeDw5QE//3pu7tXwzPxUgpj
O62j+SJZKPPfhqCFvxT8ZfciOb2X9JVEiRlOcdH6l6q8AuCzRhNVgZ6zLUGmCgyu
utMEx1cOxMS0AIrm4K18Y61SbQ/wmEIlwH+lECYdN+Ht0hgNOf2sAOLJBFovj4pd
4tNTQvXtxsqiA67WITDouDhEB1OXM9JLlojRy6vKRXUD3DXQ2BL+srji+7/nui6W
Fk7JDfUlKwz7C9yqnh8T1a2BdV/HLhl6yD/jfkTRH8edDYc5kIGgA/1vTuhqV086
Fx4zz8Ijm0kvmu/bOS5uHbFoOulnRecEjYOlvSW/PjhwMajuIlgInGSKhDx1lp8=
-----END CERTIFICATE-----

-----BEGIN CERTIFICATE-----
MIIFCTCCAvECFHoonYfNHhXRmGr3vsd2SGAy1XWhMA0GCSqGSIb3DQEBCwUAMEAx
CzAJBgNVBAYTAkNOMQswCQYDVQQIDAJIQjELMAkGA1UECwwCV0gxFzAVBgNVBAMM
DnNtYXJ0Y2F0aW8uY29tMCAXDTIzMTAyNjAzNDMwOFoYDzIwNTEwMzEzMDM0MzA4
WjBAMQswCQYDVQQGEwJDTjELMAkGA1UECAwCSEIxCzAJBgNVBAsMAldIMRcwFQYD
VQQDDA5zbWFydGNhdGlvLmNvbTCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoC
ggIBAKRuYWDX3rfJthWWREwaCP8c+gX4z5ybDyLEG13vLZPlH4pQpAn7O8U+dC0y
fdIuZYmTiUXQDEHitfIKvGfXMKnfjuRyXROD5R9I6YKzDWkeoWwnzQ8O4y5r1/l0
hVILsvqjG3FrBBzWCcxmU2Bx0RTas2RAGf3dQokUEeWGfEoI44KnxQnGYmLlF60a
7QWMwjKkAuoGP+7K53KY74xTo08yuu1w8iQrE2CamRfLHRs5YVyUJ2Wq0W6/ZIbq
iVKLZ+PeSDYcYfDVqRFHApSKN4lVsKWkjSNjtJmuhHhj8T/TiUQm+Hkj38yrXe12
XzAhFqQBRgp7SFVDXVVMozyICWfbg9bsJ5N8i2uh/CYNk+pNi7/nwnmj4kkouSXi
5oMaOIaAvrlYyOy0SBkNTMkfrB7ZDpCMAHDBcq+YnBTSb5BCvcdpvAmCxil5evTT
UBX3lE5p+X7dSqEc25l47G917ZE7Qnhqwl5aJ4Gav4YWfVsCVQoMssMqo6kjFWoe
S9H6uZCpbQd0Pq/JcyCIRKaLK+oCJX6l60s9cDpuLvfAxavXr8TZ555Ub+VHKUpP
wlfhaDNBw2jRGVyaPwaC9ONqHGzFMFR5so1M6s35EZatxCiWkUDQiFbzYgJP8PWd
dEfAMwvzMKzHkWVnevcPK0cGmJYiQ+6i4GU+b/yKuvSHgCZVAgMBAAEwDQYJKoZI
hvcNAQELBQADggIBAHYzfyTrEqDOfGMaDRYJ5ryARhtDcfZvTZFZOdngpq+Q74V1
rxf4huNgxbRVbLuIjYmkoevxkCyLQobhW3Dx+rwllIIYLb718JUIhnsHFLPxdtm3
1zhtnDO5y9IrFWfpNnTIVPSpZQcP2vo8glAcSdxQQ929QO7sUtz+eMoDpRdg3aO+
zOQI9w226+/4bJgHn1EYpyYGxyHys+Eg7AA4JXq6X3Gv1ea2yqsgjHCcQigS51go
zjHaxmWWJAdjazt2J193Lg7rgxNRDIxK0RiCrSaqEC7sLfw2pDSCv7BM5KTrv6MV
4HZDBgzkFdMoKzd03W+uM41aM+VgKdNc90nsyNkXC1S2wPDuEjV1dP/SV0nEog1X
rfWxqnDc5EqUndtAXFTGEn0izDaSwJkK9Z7T3iNxeefW63exm8GyGlMznk9JBOL4
8WmSPdS0IPcQUli1BWcswSixODfZQIkaAhoFsFnTpAc4SJb5ljknXNmVcd64PfYM
nzUJNW7Rida+NXee76l6RVEKeyBqdvXxKRZXAHDHRzFO/79kf1y6v1z+X2cS2y5W
PQHYmNY2B9dis+/Gj+k7qhDjie7gII2Zf7s61T9d5Z7YhpzmvYmXsR64R0ARSVIY
58XiJ/anhHaQ8nqP9FmcUWKcxNj0APokhJy7irzESd5VTmRqMakcxghTKuAX
-----END CERTIFICATE-----`
	caBundle = base64.StdEncoding.EncodeToString([]byte(caBundleCrt))
	t.Log(caBundle)
	_, err := NewHttpDownloader(&HttpDownloaderOptions{
		Timeout:  30,
		CaBundle: caBundle,
	})
	assert.Equal(t, err, nil)
}
